<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html" charset="UTF-8"/>
        <title>Analisis_Lexico</title>
        <link rel="stylesheet" href="estilo.css" type="text/css">        
    </head>    
    <body>
        <pre><span id = 'Comentario'>// Licensed under the Apache License, Version 2.0 (the "License");</span>
<span id = 'Comentario'>// you may not use this file except in compliance with the License.</span>
<span id = 'Comentario'>// You may obtain a copy of the License at</span>
<span id = 'Comentario'>//</span>
<span id = 'Comentario'>//     http://www.apache.org/licenses/LICENSE-2.0</span>
<span id = 'Comentario'>//</span>
<span id = 'Comentario'>// Unless required by applicable law or agreed to in writing, software</span>
<span id = 'Comentario'>// distributed under the License is distributed on an "AS IS" BASIS,</span>
<span id = 'Comentario'>// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span id = 'Comentario'>// See the License for the specific language governing permissions and</span>
<span id = 'Comentario'>// limitations under the License.</span>

<span id = 'Variable'>package</span> <span id = 'Variable'>raftserver</span>

<span id = 'Constante'>import</span> <span id = 'Puntuacion'>(</span>
	<span id = 'String'>"fmt"</span>
	<span id = 'String'>"log"</span>
	<span id = 'String'>"math/rand"</span>
	<span id = 'String'>"net"</span>
	<span id = 'String'>"net/rpc"</span>
	<span id = 'String'>"sync"</span>
	<span id = 'String'>"syscall"</span>
	<span id = 'String'>"time"</span>
<span id = 'Puntuacion'>)</span>

<span id = 'Variable'>const</span> <span id = 'Variable'>debug</span> <span id = 'Asignacion'>=</span> <span id = 'Entero'>1</span>

<span id = 'Constante'>func</span> <span id = 'Variable'>DPrintf</span><span id = 'Puntuacion'>(</span><span id = 'Constante'>for</span><span id = 'Variable'>mat</span> <span id = 'Variable'>string</span><span id = 'Invalido'>,</span> <span id = 'Variable'>a</span> <span id = 'Invalido'>.</span><span id = 'Invalido'>.</span><span id = 'Invalido'>.</span><span id = 'Constante'>in</span><span id = 'Variable'>terface</span><span id = 'Puntuacion'>{</span><span id = 'Puntuacion'>}</span><span id = 'Puntuacion'>)</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>n</span> <span id = 'Constante'>in</span><span id = 'Variable'>t</span><span id = 'Invalido'>,</span> <span id = 'Variable'>err</span> <span id = 'Variable'>error</span><span id = 'Puntuacion'>)</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Constante'>if</span> <span id = 'Variable'>debug</span> <span id = 'Invalido'>&gt</span> <span id = 'Entero'>0</span> <span id = 'Puntuacion'>{</span>
		<span id = 'Variable'>log</span><span id = 'Invalido'>.</span><span id = 'Variable'>Printf</span><span id = 'Puntuacion'>(</span><span id = 'Constante'>for</span><span id = 'Variable'>mat</span><span id = 'Invalido'>,</span> <span id = 'Variable'>a</span><span id = 'Invalido'>.</span><span id = 'Invalido'>.</span><span id = 'Invalido'>.</span><span id = 'Puntuacion'>)</span>
	<span id = 'Puntuacion'>}</span>
	<span id = 'Constante'>return</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Constante'>type</span> <span id = 'Variable'>KVRaft</span> <span id = 'Constante'>struct</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Variable'>serverList</span> <span id = 'Invalido'>[</span><span id = 'Invalido'>]</span><span id = 'Variable'>string</span>
	<span id = 'Variable'>mu</span>         <span id = 'Variable'>sync</span><span id = 'Invalido'>.</span><span id = 'Variable'>Mutex</span>
	<span id = 'Variable'>l</span>          <span id = 'Variable'>net</span><span id = 'Invalido'>.</span><span id = 'Variable'>Listener</span>
	<span id = 'Variable'>myID</span>       <span id = 'Constante'>in</span><span id = 'Variable'>t</span>
	<span id = 'Variable'>dead</span>       <span id = 'Variable'>bool</span> <span id = 'Comentario'>// for testing</span>
	<span id = 'Variable'>unreliable</span> <span id = 'Variable'>bool</span> <span id = 'Comentario'>// for testing</span>

	<span id = 'Comentario'>// Raft Persistent State</span>
	<span id = 'Variable'>currentTerm</span> <span id = 'Constante'>in</span><span id = 'Variable'>t</span>
	<span id = 'Variable'>voteFor</span>     <span id = 'Constante'>in</span><span id = 'Variable'>t</span>
	<span id = 'Variable'>log</span>         <span id = 'Aritmetico'>*</span><span id = 'Variable'>LogData</span>
	<span id = 'Variable'>role</span>        <span id = 'Variable'>Role</span>

	<span id = 'Comentario'>// Raft Volatile state (All Server)</span>
	<span id = 'Variable'>commitIndex</span> <span id = 'Constante'>in</span><span id = 'Variable'>t</span>
	<span id = 'Variable'>lastApplied</span> <span id = 'Constante'>in</span><span id = 'Variable'>t</span>

	<span id = 'Comentario'>// Raft Volatile state (Leader)</span>
	<span id = 'Variable'>nextIndex</span>  <span id = 'Constante'>in</span><span id = 'Variable'>t</span>
	<span id = 'Variable'>matchIndex</span> <span id = 'Constante'>in</span><span id = 'Variable'>t</span>

	<span id = 'Comentario'>//random time out duration</span>
	<span id = 'Variable'>timoutDuration</span> <span id = 'Variable'>time</span><span id = 'Invalido'>.</span><span id = 'Variable'>Duration</span>
	<span id = 'Variable'>heartbeat</span>      <span id = 'Variable'>time</span><span id = 'Invalido'>.</span><span id = 'Variable'>Time</span> <span id = 'Comentario'>//also use for election timer</span>
	<span id = 'Comentario'>// electionTime   time.Time</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Comentario'>//NewKVRaft :</span>
<span id = 'Constante'>func</span> <span id = 'Constante'>New</span><span id = 'Variable'>KVRaft</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>id</span> <span id = 'Constante'>in</span><span id = 'Variable'>t</span><span id = 'Invalido'>,</span> <span id = 'Variable'>srvList</span> <span id = 'Invalido'>[</span><span id = 'Invalido'>]</span><span id = 'Variable'>string</span><span id = 'Puntuacion'>)</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Variable'>kv</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Constante'>new</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>KVRaft</span><span id = 'Puntuacion'>)</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>myID</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>id</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>serverList</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>srvList</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>log</span> <span id = 'Asignacion'>=</span> <span id = 'Constante'>New</span><span id = 'Variable'>LogData</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>role</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>Follower</span>

	<span id = 'Comentario'>//random timeout</span>
	<span id = 'Variable'>rand</span><span id = 'Invalido'>.</span><span id = 'Variable'>Seed</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>time</span><span id = 'Invalido'>.</span><span id = 'Variable'>Now</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span><span id = 'Invalido'>.</span><span id = 'Variable'>UnixNano</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span><span id = 'Puntuacion'>)</span>
	<span id = 'Variable'>hbRand</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>rand</span><span id = 'Invalido'>.</span><span id = 'Constante'>In</span><span id = 'Variable'>tn</span><span id = 'Puntuacion'>(</span><span id = 'Entero'>200</span><span id = 'Puntuacion'>)</span> <span id = 'Aritmetico'>+</span> <span id = 'Entero'>50</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>timoutDuration</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>time</span><span id = 'Invalido'>.</span><span id = 'Variable'>Millisecond</span> <span id = 'Aritmetico'>*</span> <span id = 'Variable'>time</span><span id = 'Invalido'>.</span><span id = 'Variable'>Duration</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>hbRand</span><span id = 'Puntuacion'>)</span>
	<span id = 'Variable'>log</span><span id = 'Invalido'>.</span><span id = 'Variable'>Printf</span><span id = 'Puntuacion'>(</span><span id = 'String'>"Server %d HB=%d timeout=%v \n"</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>myID</span><span id = 'Invalido'>,</span> <span id = 'Variable'>hbRand</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>timoutDuration</span><span id = 'Puntuacion'>)</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>heartbeat</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>time</span><span id = 'Invalido'>.</span><span id = 'Variable'>Now</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>
	<span id = 'Constante'>return</span> <span id = 'Variable'>kv</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Comentario'>//change role</span>
<span id = 'Constante'>func</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>changeRole</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>r</span> <span id = 'Variable'>Role</span><span id = 'Puntuacion'>)</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Variable'>log</span><span id = 'Invalido'>.</span><span id = 'Variable'>Println</span><span id = 'Puntuacion'>(</span><span id = 'String'>"[ROLE] Server:"</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>myID</span><span id = 'Invalido'>,</span> <span id = 'String'>" change from "</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>role</span><span id = 'Invalido'>,</span> <span id = 'String'>" to "</span><span id = 'Invalido'>,</span> <span id = 'Variable'>r</span><span id = 'Puntuacion'>)</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>role</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>r</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Constante'>func</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>callRequestVote</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>serverAddr</span> <span id = 'Variable'>string</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>bool</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Constante'>var</span> <span id = 'Variable'>args</span> <span id = 'Variable'>RVParam</span>
	<span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>Term</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>currentTerm</span>
	<span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>CandidateId</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>myID</span>
	<span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>LastLogIndex</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>lastApplied</span>
	<span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>LastLogTerm</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>currentTerm</span>

	<span id = 'Constante'>var</span> <span id = 'Variable'>reply</span> <span id = 'Variable'>RVReply</span>
	<span id = 'Variable'>call</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>serverAddr</span><span id = 'Invalido'>,</span> <span id = 'String'>"KVRaft.RequestVote"</span><span id = 'Invalido'>,</span> <span id = 'Aritmetico'>&amp</span><span id = 'Variable'>args</span><span id = 'Invalido'>,</span> <span id = 'Aritmetico'>&amp</span><span id = 'Variable'>reply</span><span id = 'Puntuacion'>)</span>

	<span id = 'Constante'>if</span> <span id = 'Variable'>reply</span><span id = 'Invalido'>.</span><span id = 'Variable'>Term</span> <span id = 'Invalido'>&gt</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>currentTerm</span> <span id = 'Puntuacion'>{</span>
		<span id = 'Constante'>return</span> <span id = 'Constante'>false</span>
	<span id = 'Puntuacion'>}</span>
	<span id = 'Constante'>return</span> <span id = 'Variable'>reply</span><span id = 'Invalido'>.</span><span id = 'Variable'>VoteGranted</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Constante'>func</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>callHeartbeat</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>error</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Constante'>for</span> <span id = 'Variable'>_</span><span id = 'Invalido'>,</span> <span id = 'Variable'>srv</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>range</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>serverList</span> <span id = 'Puntuacion'>{</span>
		<span id = 'Constante'>var</span> <span id = 'Variable'>args</span> <span id = 'Variable'>AEParam</span>
		<span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>Term</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>currentTerm</span>
		<span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>LeaderID</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>myID</span>
		<span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>PrevLogIndex</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>lastApplied</span>
		<span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>PrevLogTerm</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>currentTerm</span> <span id = 'Aritmetico'>-</span> <span id = 'Entero'>1</span>
		<span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>Entries</span> <span id = 'Asignacion'>=</span> <span id = 'Invalido'>[</span><span id = 'Invalido'>]</span><span id = 'Variable'>string</span><span id = 'Puntuacion'>{</span><span id = 'Puntuacion'>}</span> <span id = 'Comentario'>//empty for heart beat</span>
		<span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>LeaderCommit</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>commitIndex</span>
		<span id = 'Constante'>var</span> <span id = 'Variable'>reply</span> <span id = 'Variable'>AEReply</span>
		<span id = 'Variable'>call</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>srv</span><span id = 'Invalido'>,</span> <span id = 'String'>"KVRaft.AppendEntries"</span><span id = 'Invalido'>,</span> <span id = 'Aritmetico'>&amp</span><span id = 'Variable'>args</span><span id = 'Invalido'>,</span> <span id = 'Aritmetico'>&amp</span><span id = 'Variable'>reply</span><span id = 'Puntuacion'>)</span>
	<span id = 'Puntuacion'>}</span>
	<span id = 'Constante'>return</span> <span id = 'Variable'>nil</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Comentario'>// //WhoAreYou :Return the server role</span>
<span id = 'Comentario'>// func (kv *KVRaft) WhoAreYou() string {</span>
<span id = 'Comentario'>// 	var Role string</span>

<span id = 'Comentario'>// 	switch kv.role {</span>
<span id = 'Comentario'>// 	case Follower:</span>
<span id = 'Comentario'>// 		Role = "Follower"</span>
<span id = 'Comentario'>// 	case Candidate:</span>
<span id = 'Comentario'>// 		Role = "Candidate"</span>
<span id = 'Comentario'>// 	case Leader:</span>
<span id = 'Comentario'>// 		Role = "Leader"</span>
<span id = 'Comentario'>// 	default:</span>
<span id = 'Comentario'>// 		Role = "Follower"</span>
<span id = 'Comentario'>// 	}</span>
<span id = 'Comentario'>// 	return Role</span>
<span id = 'Comentario'>// }</span>

<span id = 'Comentario'>//AppendEntries :RPC call to server to update Log Entry</span>
<span id = 'Constante'>func</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>AppendEntries</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>args</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>AEParam</span><span id = 'Invalido'>,</span> <span id = 'Variable'>reply</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>AEReply</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>error</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>heartbeat</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>time</span><span id = 'Invalido'>.</span><span id = 'Variable'>Now</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>

	<span id = 'Comentario'>//Candidte got append from leader back to followers</span>
	<span id = 'Constante'>if</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>role</span> <span id = 'Asignacion'>=</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>Candidate</span> <span id = 'Puntuacion'>{</span>
		<span id = 'Variable'>DPrintf</span><span id = 'Puntuacion'>(</span><span id = 'String'>"[Srv]:%d got leader AppendEntries - become back to follower"</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>myID</span><span id = 'Puntuacion'>)</span>
		<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>changeRole</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>Follower</span><span id = 'Puntuacion'>)</span>
	<span id = 'Puntuacion'>}</span>

	<span id = 'Comentario'>// DPrintf("[AppendEntries] args=%v", args)</span>
	<span id = 'Comentario'>//Reply false if term small than current one</span>
	<span id = 'Constante'>if</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>Term</span> <span id = 'Invalido'>&lt</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>currentTerm</span> <span id = 'Puntuacion'>{</span> <span id = 'Comentario'>//include leader case.</span>
		<span id = 'Variable'>reply</span><span id = 'Invalido'>.</span><span id = 'Variable'>Success</span> <span id = 'Asignacion'>=</span> <span id = 'Constante'>false</span>
		<span id = 'Comentario'>//apply new term and change back to follower</span>
		<span id = 'Constante'>if</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>role</span> <span id = 'Asignacion'>=</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>Leader</span> <span id = 'Puntuacion'>{</span>
			<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>currentTerm</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>Term</span>
			<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>changeRole</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>Follower</span><span id = 'Puntuacion'>)</span>
		<span id = 'Puntuacion'>}</span>
		<span id = 'Constante'>return</span> <span id = 'Variable'>nil</span>
	<span id = 'Puntuacion'>}</span>

	<span id = 'Comentario'>//Reply false if log doesn't contain an entry at previous</span>
	<span id = 'Constante'>if</span> <span id = 'Variable'>exist</span><span id = 'Invalido'>,</span> <span id = 'Constante'>in</span><span id = 'Variable'>dex</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>log</span><span id = 'Invalido'>.</span><span id = 'Variable'>ContainIndex</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>PrevLogTerm</span><span id = 'Invalido'>,</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>PrevLogIndex</span><span id = 'Puntuacion'>)</span><span id = 'Invalido'>;</span> <span id = 'Logico'>!</span><span id = 'Variable'>exist</span> <span id = 'Puntuacion'>{</span>
		<span id = 'Variable'>reply</span><span id = 'Invalido'>.</span><span id = 'Variable'>Success</span> <span id = 'Asignacion'>=</span> <span id = 'Constante'>false</span>
		<span id = 'Comentario'>// log.Println("No contain previous index or term term =&gt" + fmt.Sprint(args))</span>
		<span id = 'Constante'>return</span> <span id = 'Variable'>nil</span>
	<span id = 'Puntuacion'>}</span> <span id = 'Variable'>else</span> <span id = 'Puntuacion'>{</span>
		<span id = 'Comentario'>//If eixst a conflict value, trim it to the end</span>
		<span id = 'Constante'>if</span> <span id = 'Variable'>data</span><span id = 'Invalido'>,</span> <span id = 'Variable'>err</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>log</span><span id = 'Invalido'>.</span><span id = 'Variable'>Get</span><span id = 'Puntuacion'>(</span><span id = 'Constante'>in</span><span id = 'Variable'>dex</span><span id = 'Puntuacion'>)</span><span id = 'Invalido'>;</span> <span id = 'Variable'>err</span> <span id = 'Logico'>!</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>nil</span> <span id = 'Puntuacion'>{</span>
			<span id = 'Variable'>log</span><span id = 'Invalido'>.</span><span id = 'Variable'>Println</span><span id = 'Puntuacion'>(</span><span id = 'String'>"Get data failed on exist index, racing"</span><span id = 'Puntuacion'>)</span>
		<span id = 'Puntuacion'>}</span> <span id = 'Variable'>else</span> <span id = 'Puntuacion'>{</span>
			<span id = 'Constante'>if</span> <span id = 'Variable'>data</span><span id = 'Invalido'>.</span><span id = 'Variable'>Term</span> <span id = 'Logico'>!</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>Term</span> <span id = 'Logico'>||</span> <span id = 'Variable'>data</span><span id = 'Invalido'>.</span><span id = 'Variable'>Data</span> <span id = 'Logico'>!</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>Entries</span><span id = 'Invalido'>[</span><span id = 'Entero'>0</span><span id = 'Invalido'>]</span> <span id = 'Puntuacion'>{</span>
				<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>log</span><span id = 'Invalido'>.</span><span id = 'Variable'>TrimRight</span><span id = 'Puntuacion'>(</span><span id = 'Constante'>in</span><span id = 'Variable'>dex</span><span id = 'Puntuacion'>)</span>
			<span id = 'Puntuacion'>}</span>

		<span id = 'Puntuacion'>}</span>
	<span id = 'Puntuacion'>}</span>

	<span id = 'Constante'>if</span> <span id = 'Variable'>len</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>Entries</span><span id = 'Puntuacion'>)</span> <span id = 'Invalido'>&gt</span> <span id = 'Entero'>0</span> <span id = 'Puntuacion'>{</span>
		<span id = 'Comentario'>//Append log to storage</span>
		<span id = 'Constante'>var</span> <span id = 'Constante'>in</span><span id = 'Variable'>Logs</span> <span id = 'Invalido'>[</span><span id = 'Invalido'>]</span><span id = 'Variable'>Log</span>
		<span id = 'Constante'>for</span> <span id = 'Variable'>_</span><span id = 'Invalido'>,</span> <span id = 'Variable'>v</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>range</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>Entries</span> <span id = 'Puntuacion'>{</span>
			<span id = 'Constante'>in</span><span id = 'Variable'>Logs</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>append</span><span id = 'Puntuacion'>(</span><span id = 'Constante'>in</span><span id = 'Variable'>Logs</span><span id = 'Invalido'>,</span> <span id = 'Variable'>Log</span><span id = 'Puntuacion'>{</span><span id = 'Variable'>Term</span><span id = 'Invalido'>:</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>Term</span><span id = 'Invalido'>,</span> <span id = 'Variable'>Data</span><span id = 'Invalido'>:</span> <span id = 'Variable'>v</span><span id = 'Puntuacion'>}</span><span id = 'Puntuacion'>)</span>
		<span id = 'Puntuacion'>}</span>

		<span id = 'Comentario'>//Appen data</span>
		<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>log</span><span id = 'Invalido'>.</span><span id = 'Variable'>Append</span><span id = 'Puntuacion'>(</span><span id = 'Constante'>in</span><span id = 'Variable'>Logs</span><span id = 'Puntuacion'>)</span>

		<span id = 'Comentario'>//Update reply</span>
		<span id = 'Variable'>reply</span><span id = 'Invalido'>.</span><span id = 'Variable'>Term</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>currentTerm</span>
		<span id = 'Variable'>reply</span><span id = 'Invalido'>.</span><span id = 'Variable'>Success</span> <span id = 'Asignacion'>=</span> <span id = 'Constante'>true</span>

		<span id = 'Comentario'>//update commitIndex</span>
		<span id = 'Constante'>if</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>LeaderCommit</span> <span id = 'Invalido'>&gt</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>commitIndex</span> <span id = 'Puntuacion'>{</span>
			<span id = 'Constante'>if</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>LeaderCommit</span> <span id = 'Invalido'>&lt</span><span id = 'Asignacion'>=</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>log</span><span id = 'Invalido'>.</span><span id = 'Variable'>Length</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span> <span id = 'Aritmetico'>-</span> <span id = 'Entero'>1</span><span id = 'Puntuacion'>)</span> <span id = 'Puntuacion'>{</span>
				<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>commitIndex</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>LeaderCommit</span>
			<span id = 'Puntuacion'>}</span> <span id = 'Variable'>else</span> <span id = 'Puntuacion'>{</span>
				<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>commitIndex</span> <span id = 'Asignacion'>=</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>log</span><span id = 'Invalido'>.</span><span id = 'Variable'>Length</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span> <span id = 'Aritmetico'>-</span> <span id = 'Entero'>1</span><span id = 'Puntuacion'>)</span>
			<span id = 'Puntuacion'>}</span>
		<span id = 'Puntuacion'>}</span>
	<span id = 'Puntuacion'>}</span> <span id = 'Variable'>else</span> <span id = 'Puntuacion'>{</span>
		<span id = 'Variable'>DPrintf</span><span id = 'Puntuacion'>(</span><span id = 'String'>"Srv:%d got Heartbeat from leader %d"</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>myID</span><span id = 'Invalido'>,</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>LeaderID</span><span id = 'Puntuacion'>)</span>
	<span id = 'Puntuacion'>}</span>

	<span id = 'Comentario'>// update other</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>currentTerm</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>Term</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>lastApplied</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>log</span><span id = 'Invalido'>.</span><span id = 'Variable'>Length</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span> <span id = 'Aritmetico'>-</span> <span id = 'Entero'>1</span> <span id = 'Comentario'>//update latest state machine index</span>
	<span id = 'Comentario'>// TODO If commit &gt last applited, leader will send rest of other to fill it up</span>
	<span id = 'Comentario'>//if kv.lastApplied &lt kv.commitIndex {</span>
	<span id = 'Comentario'>//kv.lastApplied = kv.commitIndex</span>
	<span id = 'Comentario'>//}</span>

	<span id = 'Constante'>return</span> <span id = 'Variable'>nil</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Comentario'>//RequestVote :</span>
<span id = 'Constante'>func</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>RequestVote</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>args</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>RVParam</span><span id = 'Invalido'>,</span> <span id = 'Variable'>reply</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>RVReply</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>error</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Comentario'>// DPrintf("Srv:%d RequestVote got args=%v", kv.myID, args)</span>

	<span id = 'Constante'>if</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>Term</span> <span id = 'Invalido'>&gt</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>currentTerm</span> <span id = 'Logico'>&amp&amp</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>LastLogIndex</span> <span id = 'Invalido'>&gt</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>lastApplied</span> <span id = 'Puntuacion'>{</span>
		<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>voteFor</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>CandidateId</span>
		<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>heartbeat</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>time</span><span id = 'Invalido'>.</span><span id = 'Variable'>Now</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>
		<span id = 'Variable'>reply</span><span id = 'Invalido'>.</span><span id = 'Variable'>Term</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>currentTerm</span>
		<span id = 'Variable'>reply</span><span id = 'Invalido'>.</span><span id = 'Variable'>VoteGranted</span> <span id = 'Asignacion'>=</span> <span id = 'Constante'>true</span>

		<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>changeRole</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>Follower</span><span id = 'Puntuacion'>)</span>
		<span id = 'Variable'>DPrintf</span><span id = 'Puntuacion'>(</span><span id = 'String'>"Srv:%d Accept RequestVote from srv: %d"</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>myID</span><span id = 'Invalido'>,</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>CandidateId</span><span id = 'Puntuacion'>)</span>
		<span id = 'Constante'>return</span> <span id = 'Variable'>nil</span>
	<span id = 'Puntuacion'>}</span>

	<span id = 'Variable'>reply</span><span id = 'Invalido'>.</span><span id = 'Variable'>VoteGranted</span> <span id = 'Asignacion'>=</span> <span id = 'Constante'>false</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>currentTerm</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>Term</span>
	<span id = 'Variable'>DPrintf</span><span id = 'Puntuacion'>(</span><span id = 'String'>"Srv:%d Reject RequestVote from srv: %d"</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>myID</span><span id = 'Invalido'>,</span> <span id = 'Variable'>args</span><span id = 'Invalido'>.</span><span id = 'Variable'>CandidateId</span><span id = 'Puntuacion'>)</span>
	<span id = 'Constante'>return</span> <span id = 'Variable'>nil</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Constante'>func</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>serverLoop</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Constante'>for</span> <span id = 'Puntuacion'>{</span>

		<span id = 'Comentario'>//Switch every role for time out process</span>
		<span id = 'Constante'>if</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>heartbeat</span><span id = 'Invalido'>.</span><span id = 'Variable'>Add</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>timoutDuration</span><span id = 'Puntuacion'>)</span><span id = 'Invalido'>.</span><span id = 'Variable'>Before</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>time</span><span id = 'Invalido'>.</span><span id = 'Variable'>Now</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span><span id = 'Puntuacion'>)</span> <span id = 'Puntuacion'>{</span>
			<span id = 'Constante'>switch</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>role</span> <span id = 'Puntuacion'>{</span>
			<span id = 'Constante'>case</span> <span id = 'Variable'>Follower</span><span id = 'Invalido'>:</span>
				<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>followerLoop</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>
			<span id = 'Constante'>case</span> <span id = 'Variable'>Candidate</span><span id = 'Invalido'>:</span>
				<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>candidateLoop</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>
			<span id = 'Constante'>case</span> <span id = 'Variable'>Leader</span><span id = 'Invalido'>:</span>
				<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>leaderLoop</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>
			<span id = 'Puntuacion'>}</span>
		<span id = 'Puntuacion'>}</span>
		<span id = 'Comentario'>//default time thick</span>
		<span id = 'Comentario'>// DPrintf("[server] %d run loop as a Roule of %d", kv.myID, kv.role)</span>
		<span id = 'Variable'>time</span><span id = 'Invalido'>.</span><span id = 'Variable'>Sleep</span><span id = 'Puntuacion'>(</span><span id = 'Entero'>5</span> <span id = 'Aritmetico'>*</span> <span id = 'Variable'>time</span><span id = 'Invalido'>.</span><span id = 'Variable'>Millisecond</span><span id = 'Puntuacion'>)</span>
	<span id = 'Puntuacion'>}</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Constante'>func</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>followerLoop</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Comentario'>// log.Println("Srv:", kv.myID, " time=", kv.heartbeat.Add(kv.timoutDuration).String(), " now:", time.Now().String())</span>
	<span id = 'Comentario'>//change to candidate and increase term</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>changeRole</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>Candidate</span><span id = 'Puntuacion'>)</span>
	<span id = 'Constante'>return</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Constante'>func</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>candidateLoop</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>currentTerm</span><span id = 'Aritmetico'>+</span><span id = 'Aritmetico'>+</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>voteFor</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>myID</span>      <span id = 'Comentario'>//voted for self</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>heartbeat</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>time</span><span id = 'Invalido'>.</span><span id = 'Variable'>Now</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span> <span id = 'Comentario'>//reset timer for election</span>

	<span id = 'Variable'>gotVoted</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Entero'>1</span> <span id = 'Comentario'>// candidate will vote for self</span>
	<span id = 'Variable'>DPrintf</span><span id = 'Puntuacion'>(</span><span id = 'String'>"&gt&gt&gt&gt&gt&gt [server] %d Request for vote %d, term=%d"</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>myID</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>role</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>currentTerm</span><span id = 'Puntuacion'>)</span>
	<span id = 'Constante'>for</span> <span id = 'Variable'>_</span><span id = 'Invalido'>,</span> <span id = 'Variable'>srv</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>range</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>serverList</span> <span id = 'Puntuacion'>{</span>
		<span id = 'Constante'>if</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>callRequestVote</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>srv</span><span id = 'Puntuacion'>)</span> <span id = 'Puntuacion'>{</span>
			<span id = 'Variable'>gotVoted</span><span id = 'Aritmetico'>+</span><span id = 'Aritmetico'>+</span>
		<span id = 'Puntuacion'>}</span>
	<span id = 'Puntuacion'>}</span>

	<span id = 'Variable'>DPrintf</span><span id = 'Puntuacion'>(</span><span id = 'String'>"[server] %d got total voted %d the majority is %d"</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>myID</span><span id = 'Invalido'>,</span> <span id = 'Variable'>gotVoted</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>majoriry</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span><span id = 'Puntuacion'>)</span>

	<span id = 'Comentario'>//Got voted over majority</span>
	<span id = 'Constante'>if</span> <span id = 'Variable'>gotVoted</span> <span id = 'Invalido'>&gt</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>majoriry</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span> <span id = 'Puntuacion'>{</span>
		<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>changeRole</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>Leader</span><span id = 'Puntuacion'>)</span>
		<span id = 'Variable'>DPrintf</span><span id = 'Puntuacion'>(</span><span id = 'String'>"+++++++ [server] %d become to Leader"</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>myID</span><span id = 'Puntuacion'>)</span>
	<span id = 'Puntuacion'>}</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Constante'>func</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>leaderLoop</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>callHeartbeat</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Comentario'>// tell the server to shut itself down.</span>
<span id = 'Comentario'>// please do not change this function.</span>
<span id = 'Constante'>func</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>kill</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Variable'>DPrintf</span><span id = 'Puntuacion'>(</span><span id = 'String'>"Kill(%d): die\n"</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>myID</span><span id = 'Puntuacion'>)</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Comentario'>//StartServer :</span>
<span id = 'Constante'>func</span> <span id = 'Variable'>StartServer</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>rpcPort</span> <span id = 'Variable'>string</span><span id = 'Invalido'>,</span> <span id = 'Variable'>myID</span> <span id = 'Constante'>in</span><span id = 'Variable'>t</span><span id = 'Puntuacion'>)</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Constante'>return</span> <span id = 'Variable'>startServer</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>rpcPort</span><span id = 'Invalido'>,</span> <span id = 'Variable'>myID</span><span id = 'Invalido'>,</span> <span id = 'Invalido'>[</span><span id = 'Invalido'>]</span><span id = 'Variable'>string</span><span id = 'Puntuacion'>{</span><span id = 'Puntuacion'>}</span><span id = 'Puntuacion'>)</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Comentario'>//StartClusterServers :</span>
<span id = 'Constante'>func</span> <span id = 'Variable'>StartClusterServers</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>rpcPort</span> <span id = 'Variable'>string</span><span id = 'Invalido'>,</span> <span id = 'Variable'>myID</span> <span id = 'Constante'>in</span><span id = 'Variable'>t</span><span id = 'Invalido'>,</span> <span id = 'Variable'>cluster</span> <span id = 'Invalido'>[</span><span id = 'Invalido'>]</span><span id = 'Variable'>string</span><span id = 'Puntuacion'>)</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Constante'>return</span> <span id = 'Variable'>startServer</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>rpcPort</span><span id = 'Invalido'>,</span> <span id = 'Variable'>myID</span><span id = 'Invalido'>,</span> <span id = 'Variable'>cluster</span><span id = 'Puntuacion'>)</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Constante'>func</span> <span id = 'Variable'>startServer</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>serversPort</span> <span id = 'Variable'>string</span><span id = 'Invalido'>,</span> <span id = 'Variable'>myID</span> <span id = 'Constante'>in</span><span id = 'Variable'>t</span><span id = 'Invalido'>,</span> <span id = 'Variable'>cluster</span> <span id = 'Invalido'>[</span><span id = 'Invalido'>]</span><span id = 'Variable'>string</span><span id = 'Puntuacion'>)</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Variable'>kv</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Constante'>New</span><span id = 'Variable'>KVRaft</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>myID</span><span id = 'Invalido'>,</span> <span id = 'Variable'>cluster</span><span id = 'Puntuacion'>)</span>
	<span id = 'Variable'>rpcs</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>rpc</span><span id = 'Invalido'>.</span><span id = 'Constante'>New</span><span id = 'Variable'>Server</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>
	<span id = 'Variable'>rpcs</span><span id = 'Invalido'>.</span><span id = 'Variable'>Register</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span><span id = 'Puntuacion'>)</span>
	<span id = 'Variable'>go</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>serverLoop</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>

	<span id = 'Variable'>DPrintf</span><span id = 'Puntuacion'>(</span><span id = 'String'>"[server] %d port:%s as Roule of %d"</span><span id = 'Invalido'>,</span> <span id = 'Variable'>myID</span><span id = 'Invalido'>,</span> <span id = 'Variable'>serversPort</span><span id = 'Invalido'>,</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>role</span><span id = 'Puntuacion'>)</span>
	<span id = 'Variable'>l</span><span id = 'Invalido'>,</span> <span id = 'Variable'>e</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>net</span><span id = 'Invalido'>.</span><span id = 'Variable'>Listen</span><span id = 'Puntuacion'>(</span><span id = 'String'>"tcp"</span><span id = 'Invalido'>,</span> <span id = 'Variable'>serversPort</span><span id = 'Puntuacion'>)</span>
	<span id = 'Constante'>if</span> <span id = 'Variable'>e</span> <span id = 'Logico'>!</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>nil</span> <span id = 'Puntuacion'>{</span>
		<span id = 'Variable'>log</span><span id = 'Invalido'>.</span><span id = 'Variable'>Fatal</span><span id = 'Puntuacion'>(</span><span id = 'String'>"listen error: "</span><span id = 'Invalido'>,</span> <span id = 'Variable'>e</span><span id = 'Puntuacion'>)</span>
	<span id = 'Puntuacion'>}</span>
	<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>l</span> <span id = 'Asignacion'>=</span> <span id = 'Variable'>l</span>

	<span id = 'Variable'>go</span> <span id = 'Constante'>func</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span> <span id = 'Puntuacion'>{</span>
		<span id = 'Constante'>for</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>dead</span> <span id = 'Asignacion'>=</span><span id = 'Asignacion'>=</span> <span id = 'Constante'>false</span> <span id = 'Puntuacion'>{</span>
			<span id = 'Variable'>conn</span><span id = 'Invalido'>,</span> <span id = 'Variable'>err</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>l</span><span id = 'Invalido'>.</span><span id = 'Variable'>Accept</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>
			<span id = 'Constante'>if</span> <span id = 'Variable'>err</span> <span id = 'Asignacion'>=</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>nil</span> <span id = 'Logico'>&amp&amp</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>dead</span> <span id = 'Asignacion'>=</span><span id = 'Asignacion'>=</span> <span id = 'Constante'>false</span> <span id = 'Puntuacion'>{</span>
				<span id = 'Constante'>if</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>unreliable</span> <span id = 'Logico'>&amp&amp</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>rand</span><span id = 'Invalido'>.</span><span id = 'Constante'>In</span><span id = 'Variable'>t63</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span><span id = 'Aritmetico'>%</span><span id = 'Entero'>1000</span><span id = 'Puntuacion'>)</span> <span id = 'Invalido'>&lt</span> <span id = 'Entero'>100</span> <span id = 'Puntuacion'>{</span>
					<span id = 'Comentario'>// discard the request.</span>
					<span id = 'Variable'>conn</span><span id = 'Invalido'>.</span><span id = 'Variable'>Close</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>
				<span id = 'Puntuacion'>}</span> <span id = 'Variable'>else</span> <span id = 'Constante'>if</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>unreliable</span> <span id = 'Logico'>&amp&amp</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>rand</span><span id = 'Invalido'>.</span><span id = 'Constante'>In</span><span id = 'Variable'>t63</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span><span id = 'Aritmetico'>%</span><span id = 'Entero'>1000</span><span id = 'Puntuacion'>)</span> <span id = 'Invalido'>&lt</span> <span id = 'Entero'>200</span> <span id = 'Puntuacion'>{</span>
					<span id = 'Comentario'>// process the request but force discard of reply.</span>
					<span id = 'Variable'>c1</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>conn</span><span id = 'Invalido'>.</span><span id = 'Puntuacion'>(</span><span id = 'Aritmetico'>*</span><span id = 'Variable'>net</span><span id = 'Invalido'>.</span><span id = 'Variable'>UnixConn</span><span id = 'Puntuacion'>)</span>
					<span id = 'Variable'>f</span><span id = 'Invalido'>,</span> <span id = 'Variable'>_</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>c1</span><span id = 'Invalido'>.</span><span id = 'Variable'>File</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>
					<span id = 'Variable'>err</span> <span id = 'Invalido'>:</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>syscall</span><span id = 'Invalido'>.</span><span id = 'Variable'>Shutdown</span><span id = 'Puntuacion'>(</span><span id = 'Constante'>in</span><span id = 'Variable'>t</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>f</span><span id = 'Invalido'>.</span><span id = 'Variable'>Fd</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span><span id = 'Puntuacion'>)</span><span id = 'Invalido'>,</span> <span id = 'Variable'>syscall</span><span id = 'Invalido'>.</span><span id = 'Variable'>SHUT_WR</span><span id = 'Puntuacion'>)</span>
					<span id = 'Constante'>if</span> <span id = 'Variable'>err</span> <span id = 'Logico'>!</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>nil</span> <span id = 'Puntuacion'>{</span>
						<span id = 'Variable'>fmt</span><span id = 'Invalido'>.</span><span id = 'Variable'>Printf</span><span id = 'Puntuacion'>(</span><span id = 'String'>"shutdown: %v\n"</span><span id = 'Invalido'>,</span> <span id = 'Variable'>err</span><span id = 'Puntuacion'>)</span>
					<span id = 'Puntuacion'>}</span>
					<span id = 'Variable'>go</span> <span id = 'Variable'>rpcs</span><span id = 'Invalido'>.</span><span id = 'Variable'>ServeConn</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>conn</span><span id = 'Puntuacion'>)</span>
				<span id = 'Puntuacion'>}</span> <span id = 'Variable'>else</span> <span id = 'Puntuacion'>{</span>
					<span id = 'Variable'>go</span> <span id = 'Variable'>rpcs</span><span id = 'Invalido'>.</span><span id = 'Variable'>ServeConn</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>conn</span><span id = 'Puntuacion'>)</span>
				<span id = 'Puntuacion'>}</span>
			<span id = 'Puntuacion'>}</span> <span id = 'Variable'>else</span> <span id = 'Constante'>if</span> <span id = 'Variable'>err</span> <span id = 'Asignacion'>=</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>nil</span> <span id = 'Puntuacion'>{</span>
				<span id = 'Variable'>conn</span><span id = 'Invalido'>.</span><span id = 'Variable'>Close</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>
			<span id = 'Puntuacion'>}</span>
			<span id = 'Constante'>if</span> <span id = 'Variable'>err</span> <span id = 'Logico'>!</span><span id = 'Asignacion'>=</span> <span id = 'Variable'>nil</span> <span id = 'Logico'>&amp&amp</span> <span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>dead</span> <span id = 'Asignacion'>=</span><span id = 'Asignacion'>=</span> <span id = 'Constante'>false</span> <span id = 'Puntuacion'>{</span>
				<span id = 'Variable'>fmt</span><span id = 'Invalido'>.</span><span id = 'Variable'>Printf</span><span id = 'Puntuacion'>(</span><span id = 'String'>"KVRaft(%v) accept: %v\n"</span><span id = 'Invalido'>,</span> <span id = 'Variable'>myID</span><span id = 'Invalido'>,</span> <span id = 'Variable'>err</span><span id = 'Invalido'>.</span><span id = 'Variable'>Error</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span><span id = 'Puntuacion'>)</span>
				<span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>kill</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>
			<span id = 'Puntuacion'>}</span>
		<span id = 'Puntuacion'>}</span>
	<span id = 'Puntuacion'>}</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span>

	<span id = 'Constante'>return</span> <span id = 'Variable'>kv</span>
<span id = 'Puntuacion'>}</span>

<span id = 'Constante'>func</span> <span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span> <span id = 'Aritmetico'>*</span><span id = 'Variable'>KVRaft</span><span id = 'Puntuacion'>)</span> <span id = 'Variable'>majoriry</span><span id = 'Puntuacion'>(</span><span id = 'Puntuacion'>)</span> <span id = 'Constante'>in</span><span id = 'Variable'>t</span> <span id = 'Puntuacion'>{</span>
	<span id = 'Constante'>return</span> <span id = 'Variable'>len</span><span id = 'Puntuacion'>(</span><span id = 'Variable'>kv</span><span id = 'Invalido'>.</span><span id = 'Variable'>serverList</span><span id = 'Puntuacion'>)</span><span id = 'Aritmetico'>/</span><span id = 'Entero'>2</span> <span id = 'Aritmetico'>+</span> <span id = 'Entero'>1</span>
<span id = 'Puntuacion'>}</span>        </pre>
    </body>
</html>    